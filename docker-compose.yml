version: '3.9'

services:
  # PostgreSQL Database
    postgres:
        image: postgres:16-alpine
            container_name: livelox-db
                environment:
                      POSTGRES_DB: livelox
                            POSTGRES_USER: livelox
                                  POSTGRES_PASSWORD: livelox_dev_password
                                      ports:
                                            - "5432:5432"
                                                volumes:
                                                      - postgres_data:/var/lib/postgresql/data
                                                          healthcheck:
                                                                test: ["CMD-SHELL", "pg_isready -U livelox"]
                                                                      interval: 5s
                                                                            timeout: 5s
                                                                                  retries: 5
                                                                                      networks:
                                                                                            - livelox-network

                                                                                              # Redis Cache
                                                                                                redis:
                                                                                                    image: redis:7-alpine
                                                                                                        container_name: livelox-cache
                                                                                                            ports:
                                                                                                                  - "6379:6379"
                                                                                                                      volumes:
                                                                                                                            - redis_data:/data
                                                                                                                                healthcheck:
                                                                                                                                      test: ["CMD", "redis-cli", "ping"]
                                                                                                                                            interval: 5s
                                                                                                                                                  timeout: 5s
                                                                                                                                                        retries: 5
                                                                                                                                                            networks:
                                                                                                                                                                  - livelox-network
                                                                                                                                                                  
                                                                                                                                                                    # FastAPI Backend
                                                                                                                                                                      api:
                                                                                                                                                                          build:
                                                                                                                                                                                context: ./apps/api
                                                                                                                                                                                      dockerfile: Dockerfile
                                                                                                                                                                                          container_name: livelox-api
                                                                                                                                                                                              environment:
                                                                                                                                                                                                    DATABASE_URL: postgresql://livelox:livelox_dev_password@postgres:5432/livelox
                                                                                                                                                                                                          REDIS_URL: redis://redis:6379
                                                                                                                                                                                                                BALLDONTLIE_API_KEY: ${BALLDONTLIE_API_KEY:-}
                                                                                                                                                                                                                      NEXT_PUBLIC_API_BASE_URL: http://localhost:8000
                                                                                                                                                                                                                          ports:
                                                                                                                                                                                                                                - "8000:8000"
                                                                                                                                                                                                                                    depends_on:
                                                                                                                                                                                                                                          postgres:
                                                                                                                                                                                                                                                  condition: service_healthy
                                                                                                                                                                                                                                                        redis:
                                                                                                                                                                                                                                                                condition: service_healthy
                                                                                                                                                                                                                                                                    volumes:
                                                                                                                                                                                                                                                                          - ./apps/api:/app
                                                                                                                                                                                                                                                                              command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
                                                                                                                                                                                                                                                                                  networks:
                                                                                                                                                                                                                                                                                        - livelox-network
                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                          # Next.js Frontend
                                                                                                                                                                                                                                                                                            web:
                                                                                                                                                                                                                                                                                                build:
                                                                                                                                                                                                                                                                                                      context: ./apps/web
                                                                                                                                                                                                                                                                                                            dockerfile: Dockerfile
                                                                                                                                                                                                                                                                                                                container_name: livelox-web
                                                                                                                                                                                                                                                                                                                    environment:
                                                                                                                                                                                                                                                                                                                          NEXT_PUBLIC_API_BASE_URL: http://localhost:8000
                                                                                                                                                                                                                                                                                                                              ports:
                                                                                                                                                                                                                                                                                                                                    - "3000:3000"
                                                                                                                                                                                                                                                                                                                                        depends_on:
                                                                                                                                                                                                                                                                                                                                              - api
                                                                                                                                                                                                                                                                                                                                                  volumes:
                                                                                                                                                                                                                                                                                                                                                        - ./apps/web:/app
                                                                                                                                                                                                                                                                                                                                                              - /app/node_modules
                                                                                                                                                                                                                                                                                                                                                                    - /app/.next
                                                                                                                                                                                                                                                                                                                                                                        command: npm run dev
                                                                                                                                                                                                                                                                                                                                                                            networks:
                                                                                                                                                                                                                                                                                                                                                                                  - livelox-network
                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                  volumes:
                                                                                                                                                                                                                                                                                                                                                                                    postgres_data:
                                                                                                                                                                                                                                                                                                                                                                                      redis_data:
                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                      networks:
                                                                                                                                                                                                                                                                                                                                                                                        livelox-network:
                                                                                                                                                                                                                                                                                                                                                                                            driver: bridge
                                                                                                                                                                                                                                                                                                                                                                                            
